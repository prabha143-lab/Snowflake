USE DATABASE MYSNOW;

CREATE SCHEMA IF NOT EXISTS MYSTREAMS;

CREATE SCHEMA IF NOT EXISTS STAGE_TBLS;

CREATE SCHEMA IF NOT EXISTS INTG_TBLS;

CREATE TABLE STAGE_TBLS.STG_EMPL
( EMPID INT,
  EMPNAME VARCHAR(30),
  SALARY FLOAT,
  AGE INT,
  DEPT VARCHAR(10),
  LOCATION VARCHAR(20)
);

CREATE STREAM MYSTREAMS.STREAM_EMPL ON TABLE STAGE_TBLS.STG_EMPL;
CREATE STREAM MYSTREAMS.STREAM_EMPL_2 ON TABLE STAGE_TBLS.STG_EMPL;
SHOW STREAMS IN SCHEMA MYSTREAMS;

SELECT * FROM MYSTREAMS.STREAM_EMPL;--No records

CREATE TABLE INTG_TBLS.EMPL
( EMPID INT,EMPNAME VARCHAR(30),SALARY FLOAT,AGE INT,DEPT VARCHAR(15),
  LOCATION VARCHAR(20),INSRT_DT DATE,LST_UPDT_DT DATE
);

//Inserts

INSERT INTO STAGE_TBLS.STG_EMPL VALUES
(1, 'Amar', 80000, 35, 'SALES', 'Bangalore'),
(2, 'Bharath', 45000, 26, 'SALES', 'Hyderabad'),
(3, 'Charan', 76000, 34, 'TECHNOLOGY', 'Chennai'),
(4, 'Divya', 52000, 28, 'HR', 'Hyderabad'),
(5, 'Gopal', 24500, 22, 'TECHNOLOGY', 'Bangalore'),
(6, 'Haritha', 42000, 27, 'HR', 'Chennai') ;

SELECT * FROM STAGE_TBLS.STG_EMPL;

SELECT * FROM MYSTREAMS.STREAM_EMPL;

EMPID	EMPNAME	SALARY	AGE	DEPT	LOCATION	METADATA$ACTION	METADATA$ISUPDATE	METADATA$ROW_ID
1	Amar	80000	35	SALES	Bangalore	INSERT	FALSE	3c1a1f70bca07adb77aa15c86429ea172136ef99
2	Bharath	45000	26	SALES	Hyderabad	INSERT	FALSE	cef46a0d3d605763ade9cca23943467a35a68db5
3	Charan	76000	34	TECHNOLOGY	Chennai	INSERT	FALSE	917d32d5dc5d32097979426493e523a8312e28a4
4	Divya	52000	28	HR	Hyderabad	    INSERT	FALSE	1704bc0b5a0f0893441389ab8e4c12c58c5970f9
5	Gopal	24500	22	TECHNOLOGY	Bangalore INSERT	FALSE	f8ca2e8a179871b53af3ccc4141186e4ac07390e
6	Haritha	42000	27	HR	Chennai	        INSERT	FALSE	97e8ee32e042d837b2af4785614ba722d06eb2cf

INSERT INTO INTG_TBLS.EMPL
( EMPID, EMPNAME, SALARY, AGE, DEPT, LOCATION, INSRT_DT, LST_UPDT_DT)
SELECT EMPID, EMPNAME, SALARY, AGE, DEPT, LOCATION, CURRENT_DATE, NULL
FROM  MYSTREAMS.STREAM_EMPL
WHERE METADATA$ACTION = 'INSERT'
AND METADATA$ISUPDATE = FALSE;

SELECT * FROM INTG_TBLS.EMPL;

EMPID	EMPNAME	SALARY	AGE	DEPT	LOCATION	INSRT_DT	LST_UPDT_DT
1	Amar	80000	35	SALES	Bangalore	2025-09-16	
2	Bharath	45000	26	SALES	Hyderabad	2025-09-16	
3	Charan	76000	34	TECHNOLOGY	Chennai	2025-09-16	
4	Divya	52000	28	HR	Hyderabad	2025-09-16	
5	Gopal	24500	22	TECHNOLOGY	Bangalore	2025-09-16	
6	Haritha	42000	27	HR	Chennai	2025-09-16	

SELECT * FROM MYSTREAMS.STREAM_EMPL;---He consumed Stream record,Hence zero(0) records

//Updates

SELECT * FROM STAGE_TBLS.STG_EMPL;

EMPID	EMPNAME	SALARY	AGE	DEPT	LOCATION
1	Amar	80000	35	SALES	Bangalore
2	Bharath	45000	26	SALES	Hyderabad
3	Charan	76000	34	TECHNOLOGY	Chennai
4	Divya	52000	28	HR	Hyderabad
5	Gopal	24500	22	TECHNOLOGY	Bangalore
6	Haritha	42000	27	HR	Chennai

UPDATE STAGE_TBLS.STG_EMPL SET SALARY=49000 WHERE EMPID=2;
UPDATE STAGE_TBLS.STG_EMPL SET LOCATION='Pune' WHERE EMPID=5;

number of rows updated	number of multi-joined rows updated
1	0

SELECT * FROM STAGE_TBLS.STG_EMPL;

EMPID	EMPNAME	SALARY	AGE	DEPT	LOCATION
1	Amar	80000	35	SALES	Bangalore
2	Bharath	49000	26	SALES	Hyderabad
3	Charan	76000	34	TECHNOLOGY	Chennai
4	Divya	52000	28	HR	Hyderabad
5	Gopal	24500	22	TECHNOLOGY	Pune
6	Haritha	42000	27	HR	Chennai

SELECT * FROM MYSTREAMS.STREAM_EMPL order by empid;

EMPID	EMPNAME	SALARY	AGE	DEPT	LOCATION	METADATA$ACTION	METADATA$ISUPDATE	METADATA$ROW_ID
2	Bharath	49000	26	SALES	Hyderabad	INSERT	TRUE	cef46a0d3d605763ade9cca23943467a35a68db5
2	Bharath	45000	26	SALES	Hyderabad	DELETE	TRUE	cef46a0d3d605763ade9cca23943467a35a68db5
5	Gopal	24500	22	TECHNOLOGY	Pune	INSERT	TRUE	f8ca2e8a179871b53af3ccc4141186e4ac07390e
5	Gopal	24500	22	TECHNOLOGY	Bangalore	DELETE	TRUE	f8ca2e8a179871b53af3ccc4141186e4ac07390e

SELECT * FROM INTG_TBLS.EMPL;

EMPID	EMPNAME	SALARY	AGE	DEPT	LOCATION	INSRT_DT	LST_UPDT_DT
1	Amar	80000	35	SALES	Bangalore	2025-09-16	
2	Bharath	45000	26	SALES	Hyderabad	2025-09-16	
3	Charan	76000	34	TECHNOLOGY	Chennai	2025-09-16	
4	Divya	52000	28	HR	Hyderabad	2025-09-16	
5	Gopal	24500	22	TECHNOLOGY	Bangalore	2025-09-16	
6	Haritha	42000	27	HR	Chennai	2025-09-16	

MERGE INTO INTG_TBLS.EMPL E
USING MYSTREAMS.STREAM_EMPL S
 ON E.EMPID = S.EMPID
WHEN MATCHED 
    AND S.METADATA$ACTION ='INSERT'
    AND S.METADATA$ISUPDATE ='TRUE'
THEN UPDATE 
    SET E.EMPNAME = S.EMPNAME,
  E.SALARY = S.SALARY,
  E.AGE = S.AGE,
  E.DEPT = S.DEPT,
  E.LOCATION = S.LOCATION,
  E.LST_UPDT_DT = CURRENT_DATE;  

  number of rows updated
2

SELECT * FROM INTG_TBLS.EMPL;

EMPID	EMPNAME	SALARY	AGE	DEPT	LOCATION	INSRT_DT	LST_UPDT_DT
1	Amar	80000	35	SALES	Bangalore	2025-09-16	
3	Charan	76000	34	TECHNOLOGY	Chennai	2025-09-16	
4	Divya	52000	28	HR	Hyderabad	2025-09-16	
2	Bharath	49000	26	SALES	Hyderabad	2025-09-16	2025-09-16
5	Gopal	24500	22	TECHNOLOGY	Pune	2025-09-16	2025-09-16
6	Haritha	42000	27	HR	Chennai	2025-09-16	

SELECT * FROM MYSTREAMS.STREAM_EMPL;---He consumed Stream record,Hence zero(0) records


//Deletes

SELECT * FROM STAGE_TBLS.STG_EMPL;

EMPID	EMPNAME	SALARY	AGE	DEPT	LOCATION
1	Amar	80000	35	SALES	Bangalore
2	Bharath	49000	26	SALES	Hyderabad
3	Charan	76000	34	TECHNOLOGY	Chennai
4	Divya	52000	28	HR	Hyderabad
5	Gopal	24500	22	TECHNOLOGY	Pune
6	Haritha	42000	27	HR	Chennai

DELETE FROM STAGE_TBLS.STG_EMPL WHERE EMPID in (3,4);

number of rows deleted
2

SELECT * FROM STAGE_TBLS.STG_EMPL;

EMPID	EMPNAME	SALARY	AGE	DEPT	LOCATION
1	Amar	80000	35	SALES	Bangalore
2	Bharath	49000	26	SALES	Hyderabad
5	Gopal	24500	22	TECHNOLOGY	Pune
6	Haritha	42000	27	HR	Chennai

SELECT * FROM MYSTREAMS.STREAM_EMPL;

EMPID	EMPNAME	SALARY	AGE	DEPT	LOCATION	METADATA$ACTION	METADATA$ISUPDATE	METADATA$ROW_ID
3	Charan	76000	34	TECHNOLOGY	Chennai	DELETE	FALSE	917d32d5dc5d32097979426493e523a8312e28a4
4	Divya	52000	28	HR	Hyderabad	DELETE	FALSE	1704bc0b5a0f0893441389ab8e4c12c58c5970f9


MERGE INTO INTG_TBLS.EMPL E
USING MYSTREAMS.STREAM_EMPL S
 ON E.EMPID = S.EMPID
WHEN MATCHED 
    AND S.METADATA$ACTION ='DELETE'
    AND S.METADATA$ISUPDATE ='FALSE'
THEN DELETE;

number of rows deleted
2

SELECT * FROM INTG_TBLS.EMPL;

EMPID	EMPNAME	SALARY	AGE	DEPT	LOCATION	INSRT_DT	LST_UPDT_DT
1	Amar	80000	35	SALES	Bangalore	2025-09-16	
2	Bharath	49000	26	SALES	Hyderabad	2025-09-16	2025-09-16
5	Gopal	24500	22	TECHNOLOGY	Pune	2025-09-16	2025-09-16
6	Haritha	42000	27	HR	Chennai	2025-09-16	

SELECT * FROM MYSTREAMS.STREAM_EMPL;--He consumed Stream record,Hence zero(0) records




//All changes at a time

SELECT * FROM STAGE_TBLS.STG_EMPL;

EMPID	EMPNAME	SALARY	AGE	DEPT	LOCATION
1	Amar	80000	35	SALES	Bangalore
2	Bharath	49000	26	SALES	Hyderabad
5	Gopal	24500	22	TECHNOLOGY	Pune
6	Haritha	42000	27	HR	Chennai

INSERT INTO STAGE_TBLS.STG_EMPL VALUES
(7, 'Janaki', 61000, 29, 'SALES', 'Pune'),
(8, 'Kamal', 92000, 33, 'TECHNOLOGY', 'Bangalore');

number of rows inserted
2

UPDATE STAGE_TBLS.STG_EMPL 
SET SALARY=85000, LOCATION='Hyderabad' WHERE EMPID=1;

number of rows updated	number of multi-joined rows updated
1	0

DELETE FROM STAGE_TBLS.STG_EMPL WHERE EMPID in (6);

number of rows deleted
1

SELECT * FROM STAGE_TBLS.STG_EMPL;

EMPID	EMPNAME	SALARY	AGE	DEPT	LOCATION
1	Amar	85000	35	SALES	Hyderabad
2	Bharath	49000	26	SALES	Hyderabad
5	Gopal	24500	22	TECHNOLOGY	Pune
7	Janaki	61000	29	SALES	Pune
8	Kamal	92000	33	TECHNOLOGY	Bangalore

SELECT * FROM MYSTREAMS.STREAM_EMPL;

EMPID	EMPNAME	SALARY	AGE	DEPT	LOCATION	METADATA$ACTION	METADATA$ISUPDATE	METADATA$ROW_ID
1	Amar	85000	35	SALES	Hyderabad	INSERT	TRUE	3c1a1f70bca07adb77aa15c86429ea172136ef99
7	Janaki	61000	29	SALES	Pune	INSERT	FALSE	1b361fc8acef629ca1b07c99e9621751ceb05fb6
8	Kamal	92000	33	TECHNOLOGY	Bangalore	INSERT	FALSE	58166e345f9c21dbeb4b6b2ecca1a220171cdc55
1	Amar	80000	35	SALES	Bangalore	DELETE	TRUE	3c1a1f70bca07adb77aa15c86429ea172136ef99
6	Haritha	42000	27	HR	Chennai	DELETE	FALSE	97e8ee32e042d837b2af4785614ba722d06eb2cf

MERGE INTO INTG_TBLS.EMPL T
USING MYSTREAMS.STREAM_EMPL S
 ON T.EMPID = S.EMPID
WHEN MATCHED
    AND S.METADATA$ACTION ='DELETE' 
    AND S.METADATA$ISUPDATE = 'FALSE'
    THEN DELETE                   
WHEN MATCHED
    AND S.METADATA$ACTION ='INSERT' 
    AND S.METADATA$ISUPDATE  = 'TRUE'       
    THEN UPDATE 
    SET T.EMPNAME = S.EMPNAME,
  T.SALARY = S.SALARY,
  T.AGE = S.AGE,
  T.DEPT = S.DEPT,
  T.LOCATION = S.LOCATION,
  T.LST_UPDT_DT = CURRENT_DATE
WHEN NOT MATCHED
    AND S.METADATA$ACTION ='INSERT'
 AND S.METADATA$ISUPDATE  = 'FALSE'
    THEN INSERT( EMPID, EMPNAME, SALARY, AGE, DEPT, LOCATION, INSRT_DT, LST_UPDT_DT)
 VALUES(S.EMPID, S.EMPNAME, S.SALARY, S.AGE, S.DEPT, S.LOCATION, CURRENT_DATE, NULL);
 
SELECT * FROM INTG_TBLS.EMPL;

EMPID	EMPNAME	SALARY	AGE	DEPT	LOCATION	INSRT_DT	LST_UPDT_DT
2	Bharath	49000	26	SALES	Hyderabad	2025-09-16	2025-09-16
5	Gopal	24500	22	TECHNOLOGY	Pune	2025-09-16	2025-09-16
1	Amar	85000	35	SALES	Hyderabad	2025-09-16	2025-09-16
7	Janaki	61000	29	SALES	Pune	2025-09-16	
8	Kamal	92000	33	TECHNOLOGY	Bangalore	2025-09-16	

SELECT * FROM MYSTREAMS.STREAM_EMPL;----He consumed Stream record,Hence zero(0) records


//With Tasks

CREATE OR REPLACE TASK MYTASKS.TASK_EMPL_DATA_LOAD
    WAREHOUSE = MYOWN_WH
    SCHEDULE = '5 MINUTES'
    WHEN SYSTEM$STREAM_HAS_DATA('MYSTREAMS.STREAM_EMPL')
AS 
MERGE INTO INTG_TBLS.EMPL T
USING MYSTREAMS.STREAM_EMPL S
 ON T.EMPID = S.EMPID
WHEN MATCHED
    AND S.METADATA$ACTION ='DELETE' 
    AND S.METADATA$ISUPDATE = 'FALSE'
    THEN DELETE                   
WHEN MATCHED
    AND S.METADATA$ACTION ='INSERT' 
    AND S.METADATA$ISUPDATE  = 'TRUE'       
    THEN UPDATE 
    SET T.EMPNAME = S.EMPNAME,
  T.SALARY = S.SALARY,
  T.AGE = S.AGE,
  T.DEPT = S.DEPT,
  T.LOCATION = S.LOCATION,
  T.LST_UPDT_DT = CURRENT_DATE
WHEN NOT MATCHED
    AND S.METADATA$ACTION ='INSERT'
 AND S.METADATA$ISUPDATE  = 'FALSE'
    THEN INSERT( EMPID, EMPNAME, SALARY, AGE, DEPT, LOCATION, INSRT_DT, LST_UPDT_DT)
 VALUES(S.EMPID, S.EMPNAME, S.SALARY, S.AGE, S.DEPT, S.LOCATION, CURRENT_DATE, NULL);

ALTER TASK MYTASKS.TASK_EMPL_DATA_LOAD RESUME;
SELECT * FROM STAGE_TBLS.STG_EMPL;

INSERT INTO STAGE_TBLS.STG_EMPL VALUES
(9, 'Latha', 47000, 25, 'HR', 'Chennai');

UPDATE STAGE_TBLS.STG_EMPL 
SET SALARY=67000 WHERE EMPID=7;

DELETE FROM STAGE_TBLS.STG_EMPL WHERE EMPID in (8);

SELECT * FROM MYSTREAMS.STREAM_EMPL;

SELECT * FROM INTG_TBLS.EMPL;

SELECT * FROM MYSTREAMS.STREAM_EMPL;